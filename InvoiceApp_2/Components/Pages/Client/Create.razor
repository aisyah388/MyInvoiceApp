@page "/client/add"
@using MyInvoiceApp_Shared.DTO
@using static MyInvoiceApp_Shared.DTO.Validation

<MudText Typo="Typo.h4">Add New Client</MudText>
<MudGrid>
    <MudItem xs="12" sm="6" md="6" xl="6">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Client Details</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="4">
                        <MudText Typo="Typo.body1">Name</MudText>
                    </MudItem>
                    <MudItem xs="8">
                        <MudTextField @bind-Value="@client.Name" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudText Typo="Typo.body1">Address</MudText>
                    </MudItem>
                    <MudItem xs="8">
                        <MudTextField @bind-Value="@client.Address" AutoGrow MaxLines="8" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudText Typo="Typo.body1">Phone</MudText>
                    </MudItem>
                    <MudItem xs="8">
                        <MudTextField @bind-Value="@client.Phone" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudText Typo="Typo.body1">Email</MudText>
                    </MudItem>
                    <MudItem xs="8">
                        <MudTextField @bind-Value="@client.Email" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
                <MudButton Variant="Variant.Filled" Style="margin-top: 1rem" StartIcon="@Icons.Material.Filled.Save" Color="Color.Primary" OnClick="AddNewClient">
                    Save Changes
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private Client client = new();

    // Store validation errors
    private Dictionary<string, string> validationErrors = new();

    protected override async Task OnInitializedAsync()
    {
        
    }

    private async Task AddNewClient()
    {
        // Clear previous errors
        validationErrors.Clear();

        try
        {
            var response = await Http.PostAsJsonAsync("api/client/add", client);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Client details saved successfully.", Severity.Success);
                Navigation.NavigateTo("/client/list");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
            {
                // Parse validation errors
                var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();

                if (errorResponse?.Errors != null && errorResponse.Errors.Any())
                {
                    // Store errors in dictionary for display
                    foreach (var error in errorResponse.Errors)
                    {
                        validationErrors[error.Property] = error.Error;
                    }

                    // Show summary in snackbar
                    Snackbar.Add($"Please fill all required fields.", Severity.Error);
                }
                else
                {
                    // Fallback if errors array is empty
                    var rawError = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Validation failed: {rawError}", Severity.Error);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to save client details: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private string GetErrorForField(string fieldName)
    {
        return validationErrors.ContainsKey(fieldName) ? validationErrors[fieldName] : null;
    }                                                                                                                                   
}
